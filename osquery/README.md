Code stolen from https://github.com/NixOS/nixpkgs/pull/201562
all credits to @jdbaldry
